# Helsinki City Bike App

An application where you can view journey details and station details generated by bikes in Helsinki Capital area.

Dataset is downloaded from here:

- https://dev.hsl.fi/citybikes/od-trips-2021/2021-05.csv
- https://dev.hsl.fi/citybikes/od-trips-2021/2021-06.csv
- https://dev.hsl.fi/citybikes/od-trips-2021/2021-07.csv

License and Other helpful info:

- Dataset: https://opendata.arcgis.com/datasets/726277c507ef4914b0aec3cbcfcbfafc_0.csv
- License and information: https://www.avoindata.fi/data/en/dataset/hsl-n-kaupunkipyoraasemat/resource/a23eef3a-cc40-4608-8aa2-c730d17e8902

## Deployment 

Project has been deployed using fly.io
Live URL: https://helsinki-city-bike.fly.dev/

CI pipeline has been setup using github actions: https://github.com/sirbh/helsinki-city-bike/actions


## Tech used

### Backend
* [Node.js](https://nodejs.org/)
* [Express](https://expressjs.com/)
* [TypeScript](https://www.typescriptlang.org/)
* [Docker](https://www.docker.com/)
* [Morgan](https://expressjs.com/en/resources/middleware/morgan.html)
* [Git](https://git-scm.com/)

### Frontend
* [ReactJs](https://react.dev/)
* [MaterialUI](https://mui.com/)
* [Axios](https://axios-http.com/docs/intro)
* [Tanstack query](https://tanstack.com/query/v3/)

### Storage
* [PostgreSQL](https://www.postgresql.org/)
* [Prisma ORM](https://www.prisma.io/)

### Testing
* [Jest](https://www.chaijs.com/)
* [Supertest](https://www.npmjs.com/package/supertest)
* [Cypress](https://www.cypress.io/)

## Running the app

Docker can be used to setup the dev environment. Make sure you have docker installed and running.

First copy following files in `db/files` of project root.
- https://dev.hsl.fi/citybikes/od-trips-2021/2021-05.csv
- https://dev.hsl.fi/citybikes/od-trips-2021/2021-06.csv
- https://dev.hsl.fi/citybikes/od-trips-2021/2021-07.csv
- https://opendata.arcgis.com/datasets/726277c507ef4914b0aec3cbcfcbfafc_0.csv

To start dev server simply run the following command in terminal opened in root of project directory:

```
docker compose -f docker-compose.dev.yml up
```
after running the above command the app will be live on `http://localhost:3000/`

## Running the tests

Again for testing separate docker file has been created. To run the test simply run the following command.

```
docker compose -f docker-compose.test.yml up
```
The above command will run the e2e test automaticaly but to run unit test you need to open the bash for the container `backend-test` with the following command:

```
docker exec -it backend-test bash
```

After running above command you can access the terminal to the backend server and unit test can be run by `npm run test`

## API Documentation

### Journeys API

1. `/api/journeys`  return journey details and total journeys records.
 
 - `?take=10&page=2`
    </br>
    </br>
    Both `take` and `page` are required field and can be of type `integer`.
    </br>
    </br>
     Example request `/api/journeys?take=3&page=2`
    </br>
    </br>
    Example response:
    </br>
    </br>
    ```json
    {
    "count": 1564379,
    "details": [
        {
            "id": 606,
            "departure_time": "2021-05-31T21:16:53.000Z",
            "return_time": "2021-05-31T21:20:09.000Z",
            "departure_station_id": 541,
            "departure_station_name": "Aalto-yliopisto (M), Korkeakouluaukio",
            "return_station_id": 547,
            "return_station_name": "J채mer채ntaival",
            "covered_distance": "699",
            "duration": 196
        },
        {
            "id": 883,
            "departure_time": "2021-05-31T20:41:56.000Z",
            "return_time": "2021-05-31T21:08:56.000Z",
            "departure_station_id": 541,
            "departure_station_name": "Aalto-yliopisto (M), Korkeakouluaukio",
            "return_station_id": 517,
            "return_station_name": "L채nsituuli",
            "covered_distance": "2360",
            "duration": 1614
        },
        {
            "id": 904,
            "departure_time": "2021-05-31T20:40:08.000Z",
            "return_time": "2021-05-31T20:41:38.000Z",
            "departure_station_id": 541,
            "departure_station_name": "Aalto-yliopisto (M), Korkeakouluaukio",
            "return_station_id": 541,
            "return_station_name": "Aalto-yliopisto (M), Korkeakouluaukio",
            "covered_distance": "51",
            "duration": 86
        }
      ]
    }
    ```
 - `?sort_prop=duration&order=asc` 
    </br>
    </br>
    `sort_prop` is property by which we want to want to sort the journey details.</br>
    possible options are: `duration`,`covered_distance`,`departure_station_name` or `return_station_name`</br>
    default value:`departure_station_name`.
    </br>
    </br>
    `order` defines the order of sorting.
    possible options are: `asc` or `desc`
    default value:`asc`.
    </br>
    </br>
    Example request `/api/journeys?take=3&page=2&sort_prop=duration&order=asc`
    </br>
    </br>
    Example response:
    </br>
    </br>
    ```json
      {
    "count": 1564379,
    "details": [
        {
            "id": 1281569,
            "departure_time": "2021-07-14T17:11:54.000Z",
            "return_time": "2021-07-14T17:12:13.000Z",
            "departure_station_id": 208,
            "departure_station_name": "Valimotie",
            "return_station_id": 208,
            "return_station_name": "Valimotie",
            "covered_distance": "53",
            "duration": 14
        },
        {
            "id": 314285,
            "departure_time": "2021-05-09T12:31:40.000Z",
            "return_time": "2021-05-09T12:31:59.000Z",
            "departure_station_id": 43,
            "departure_station_name": "Karhupuisto",
            "return_station_id": 43,
            "return_station_name": "Karhupuisto",
            "covered_distance": "10",
            "duration": 15
        },
        {
            "id": 1251924,
            "departure_time": "2021-07-15T22:50:45.000Z",
            "return_time": "2021-07-15T22:51:04.000Z",
            "departure_station_id": 111,
            "departure_station_name": "Esterinportti",
            "return_station_id": 111,
            "return_station_name": "Esterinportti",
            "covered_distance": "125",
            "duration": 15
        }
      ]
    }
    ```
 - `?filter_prop=departure_station_id&id=512`
    </br>
    </br>
    `filter_prop` is property by which we want to want to filter the journey details.</br>
    possible options are: `departure_station_id` or `return_station_id`.</br>
    `id` is the `integer` station id of the station by which we want to filter.
    </br>
    </br>
    Example request `/api/journeys?take=3&page=2&sort_prop=duration&order=asc&filter_props=return_station_id&id=12`
    </br>
    </br>
    Example response:
    </br>
    </br>
    ```json
    {
    "count": 15310,
    "details": [
        {
            "id": 880573,
            "departure_time": "2021-06-06T00:34:59.000Z",
            "return_time": "2021-06-06T00:35:31.000Z",
            "departure_station_id": 12,
            "departure_station_name": "Kanavaranta",
            "return_station_id": 12,
            "return_station_name": "Kanavaranta",
            "covered_distance": "18",
            "duration": 28
        },
        {
            "id": 389854,
            "departure_time": "2021-05-01T11:04:04.000Z",
            "return_time": "2021-05-01T11:04:38.000Z",
            "departure_station_id": 12,
            "departure_station_name": "Kanavaranta",
            "return_station_id": 12,
            "return_station_name": "Kanavaranta",
            "covered_distance": "241.67",
            "duration": 29
        },
        {
            "id": 1213377,
            "departure_time": "2021-07-17T22:29:23.000Z",
            "return_time": "2021-07-17T22:29:56.000Z",
            "departure_station_id": 12,
            "departure_station_name": "Kanavaranta",
            "return_station_id": 12,
            "return_station_name": "Kanavaranta",
            "covered_distance": "24",
            "duration": 29
        }
      ]
    }
    ```

### Stations API

1. `/api/stations/`  return stations details and total count of records.

 - `?take=10&?page=2`
    </br>
    </br>
    Both `take` and `page` are required field and can be of type `integer`.
    </br>
    </br>
    Example request `/api/stations/?take=3&?page=2`
    </br>
    </br>
    Example response:
    </br>
    </br>
    ```json
    {
    "count": 457,   // total number of records
    "details": [    // stations details as array
        {
            "id": 4,
            "name": "Viiskulma",
            "address": "Fredriksgatan  19",
            "city": "Espoo",
            "operator": "CityBike Finland",
            "capacity": 14,
            "x": "24.9417758006418",
            "y": "60.1609858921764"
        },
        {
            "id": 5,
            "name": "Sep채nkatu",
            "address": "Fabriksgatan 25",
            "city": "Espoo",
            "operator": "CityBike Finland",
            "capacity": 32,
            "x": "24.9362853002102",
            "y": "60.157948291819"
        },
        {
            "id": 6,
            "name": "Hietalahdentori",
            "address": "Sandviksgatan 2",
            "city": "Espoo",
            "operator": "CityBike Finland",
            "capacity": 24,
            "x": "24.9296476311878",
            "y": "60.1622283898112"
        }
      ]
    }
    ```

2. `/api/stations/search`  return station list corresponding to `query` param

 - `?query=aa`
    </br>
    </br>
   `query` is required field and can be of type `string`.
    </br>
    </br>
    Example request `/api/stations/search?query=aa`
    </br>
    </br>
    Example response:
    </br>
    </br>
    ```json
    [
    {
        "id": 539,
        "name": "Aalto University (M), Tietotie"
    },
    {
        "id": 541,
        "name": "Aalto University (M), Korkeakoulua"
    }
    ]
    ```

   

3. `/api/stations/${id}` return details of station whose id is provided

 - `id` is of type integer.
  </br>
  </br>
 Example request `/api/stations/12`
  </br>
  </br>
Example response:
    </br>
    </br>

```
{
    "details": {
        "id": 12,
        "name": "Kanavaranta",
        "address": "Kanalkajen 1",
        "city": "Espoo",
        "operator": "CityBike Finland",
        "capacity": 34,
        "x": "24.9584922784237",
        "y": "60.1684959040351"
    },
    "total_departures": 15310,                            // total journeys started from station
    "total_return": 15724,                                // total jourenys ended at station
    "avg_departure_distance": "2569.2210333115610712", 
    "avg_return_distance": "2531.6398499109641313",
    "popular_departure_stations": [                       
        {
            "_count": {
                "return_station_id": 612
            },
            "departure_station_id": 123,
            "departure_station_name": "N채kinsilta"
        },
        {
            "_count": {
                "return_station_id": 610
            },
            "departure_station_id": 1,
            "departure_station_name": "Kaivopuisto"
        },
        {
            "_count": {
                "return_station_id": 604
            },
            "departure_station_id": 16,
            "departure_station_name": "Liisanpuistikko"
        },
        {
            "_count": {
                "return_station_id": 490
            },
            "departure_station_id": 40,
            "departure_station_name": "Hakaniemi (M)"
        },
        {
            "_count": {
                "return_station_id": 472
            },
            "departure_station_id": 122,
            "departure_station_name": "Lintulahdenkatu"
        }
    ],
    "popular_return_station": [
        {
            "_count": {
                "departure_station_id": 633
            },
            "return_station_id": 16,
            "return_station_name": "Liisanpuistikko"
        },
        {
            "_count": {
                "departure_station_id": 584
            },
            "return_station_id": 123,
            "return_station_name": "N채kinsilta"
        },
        {
            "_count": {
                "departure_station_id": 583
            },
            "return_station_id": 40,
            "return_station_name": "Hakaniemi (M)"
        },
        {
            "_count": {
                "departure_station_id": 528
            },
            "return_station_id": 41,
            "return_station_name": "Ympyr채talo"
        },
        {
            "_count": {
                "departure_station_id": 504
            },
            "return_station_id": 121,
            "return_station_name": "Vilhonvuorenkatu"
        }
    ]
}
```


## Further scope of improvements



 - Functionality to add stations with help of GooglePlaces API.
 - Functionality to add journeys.
 - Cypress test can be moved into its own folder.
 - Performance can be improved using hooks like `useMemo` and `useCallback`. 
 - Adding authentication so that only some privileged user can add stations and journeys.
 - More validations can be added to database.
 - Relations can be added to database. 
 - Swagger can be added for  API management.




